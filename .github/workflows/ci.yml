name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

permissions:
  contents: read

jobs:
  # Core package tests
  core:
    runs-on: ubuntu-latest
    name: Core Package
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: "1.x"

      - name: Cache Bun dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: |
          set -e
          bun install || (echo "bun install failed, clearing cache and retrying..." && (bun pm cache rm || bun pm cache clean || true) && bun install)

      - name: TypeScript check
        run: cd packages/core && bun run tsc --noEmit

      - name: Run unit tests
        run: cd packages/core && bun test --coverage --coverage-reporter=lcov

      - name: Cloud app tests
        run: bun run --filter mindwtr-cloud test

      - name: Upload core coverage report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: coverage-core
          path: packages/core/coverage/lcov.info
          if-no-files-found: error
          retention-days: 28

  # Desktop app build and tests (Tauri)
  desktop:
    runs-on: ubuntu-latest
    name: Desktop App (Tauri)
    timeout-minutes: 45
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install system dependencies (Tauri)
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libasound2-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable

      - name: Ensure Rust toolchain (retry)
        uses: nick-fields/retry@ce71cc2ab81d554ebbe88c79ab5975992d79ba08 # v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: |
            rustup toolchain install stable --profile minimal --no-self-update
            rustup default stable

      - name: Cache Rust artifacts
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2
        with:
          workspaces: apps/desktop/src-tauri

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0"

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: "1.x"

      - name: Cache Bun dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: TypeScript check
        run: cd apps/desktop && bun run tsc --noEmit

      - name: Run tests
        run: cd apps/desktop && bun test --coverage --coverage-reporter=lcov

      - name: Upload desktop coverage report
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: coverage-desktop
          path: apps/desktop/coverage/lcov.info
          if-no-files-found: error
          retention-days: 28

      - name: Build Vite frontend
        run: cd apps/desktop && bun run build:vite

      - name: Build Tauri app (debug, no bundle)
        timeout-minutes: 20
        run: cd apps/desktop && cargo tauri build --debug --no-bundle

  # Mobile app validation
  mobile:
    runs-on: ubuntu-latest
    name: Mobile App
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: "1.x"

      - name: Cache Bun dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: TypeScript check
        run: cd apps/mobile && bunx tsc --noEmit

      - name: Expo Doctor check
        run: cd apps/mobile && bunx expo-doctor
        continue-on-error: true

      - name: Mobile tests
        run: bun run --filter mobile test

  # Lint check
  lint:
    runs-on: ubuntu-latest
    name: Code Quality
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: "1.x"

      - name: Cache Bun dependencies
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install

      - name: Performance audit
        run: bun run scripts/audit-performance.ts --fail-under 60

      - name: Check for lint errors (core)
        run: cd packages/core && bun run tsc --noEmit

      - name: Check for lint errors (desktop)
        run: cd apps/desktop && bun run lint

      - name: Check for lint errors (mobile)
        run: cd apps/mobile && bun run lint
